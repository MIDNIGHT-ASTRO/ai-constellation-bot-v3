<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë¯¸ë“œë‚˜ì‡ì˜ ì²œë¬¸ í€´ì¦ˆ (with. AI)</title>
  <style>
    :root { --fg:#0f172a; --muted:#6b7280; --bg:#f6f7fb; --card:#fff; --line:#e5e7eb;
            --primary:#111827; --ok:#16a34a; --bad:#dc2626; --btn:#fff; }

    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, system-ui, Segoe UI, Roboto, 'Noto Sans KR', sans-serif; background: var(--bg); color: var(--fg); }

    header {
      position: sticky; top: 0; z-index: 10;
      background: rgba(246,247,251,.85); backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--line);
    }
    .wrap { max-width: 980px; margin: 0 auto; padding: 14px 16px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .space { flex: 1; }
    .hint { color: var(--muted); font-size: 12px; }

    button { appearance: none; border:1px solid var(--line); background: var(--btn);
      padding:10px 14px; border-radius: 12px; cursor:pointer; }
    button.primary { background: var(--primary); color:#fff; border:none; }
    button.ghost { background:transparent; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .seg { display:flex; gap:6px; flex-wrap:wrap; }

    main { padding: 22px 16px 10px; }
    .card {
      margin: 0 auto; max-width: 880px; background: var(--card);
      border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.06);
      border:1px solid var(--line); padding: 18px;
      animation: fadeIn .28s ease;
    }
    @keyframes fadeIn { from { opacity:0; transform: translateY(8px); } to { opacity:1; transform:none; } }

    .qtitle { font-size: 18px; font-weight: 700; line-height: 1.35; }
    .qmeta { margin-top: 6px; font-size: 12px; color: var(--muted); }
    .qimg-wrap { margin: 10px 0 6px; display:flex; justify-content:center; }
    .qimg {
      max-width:100%; height:auto; max-height: 42vh; object-fit: contain;
      border:1px solid var(--line); border-radius:8px; background:#fff; cursor: zoom-in;
    }
    .qimg.lg { max-height: 86vh; cursor: zoom-out; }
    @media (max-width: 640px) { .qimg { max-height: 52vh; } }

    .opts { display:grid; gap:10px; margin-top: 10px; }
    .opts.cols-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .opts.cols-1 { grid-template-columns: 1fr; }
    .opt-btn {
      padding: 12px; text-align:left; border:1px solid var(--line); border-radius:12px;
      background:#fff; transition: transform .06s ease, border-color .06s ease;
    }
    .opt-btn:hover { transform: translateY(-1px); }
    .opt-btn.correct { border-color: #86efac; box-shadow: 0 0 0 3px rgba(22,163,74,.15) inset; }
    .opt-btn.wrong   { border-color: #fca5a5; box-shadow: 0 0 0 3px rgba(220,38,38,.12) inset; }

    .result { margin-top: 12px; padding: 10px 12px; border-radius:12px; font-weight:600; }
    .result.ok  { background: #ecfdf5; color:#065f46; }
    .result.bad { background: #fef2f2; color:#7f1d1d; }

    .footer { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:14px; }
    .badge { border:1px solid var(--line); border-radius: 999px; padding: 4px 10px; font-size: 12px; }
    .badge.ok { color:#047857; border-color:#34d399; }
    .badge.fail { color:#b91c1c; border-color:#f87171; }

    .brand { max-width: 980px; margin: 10px auto 0; text-align:center; }
    .brand img { max-width: 130px; width: 30%; height: auto; opacity: .95;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.08)); }

    .credit { margin: 16px auto 24px; padding: 12px; text-align: center;
      font-size: 12px; line-height: 1.6; color: #6b7280; max-width: 980px; }
    .credit .yt { display: inline-block; margin-top: 6px; font-weight: 600;
      color: #1d4ed8; text-decoration: none; }
    .credit .yt:hover { text-decoration: underline; }
    .credit .warn { display: block; margin-top: 12px; font-size: 11px; color: #b91c1c; }
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <div style="font-weight:800;">ë¯¸ë“œë‚˜ì‡ì˜ ì²œë¬¸ í€´ì¦ˆ (with. AI)</div>
      <div class="space"></div>
      <div id="health" class="badge fail">ì„œë²„ ì—°ê²° í™•ì¸ ì¤‘â€¦</div>
    </div>
    <div class="wrap">
      <div class="seg">
        <button data-mode="random"   class="primary">ëœë¤</button>
        <button data-mode="image">ì„±ë„(ì´ë¯¸ì§€)</button>
        <button data-mode="season">ê³„ì ˆ</button>
        <button data-mode="star">ë°ì€ ë³„ ì†Œì†</button>
        <button data-mode="hemisphere">ë¶Â·ë‚¨ë°˜êµ¬ êµ¬ë¶„</button>
        <button data-mode="lunar">ë‹¬</button>
        <button data-mode="solar">íƒœì–‘ê³„</button>
      </div>
      <div class="hint" style="margin-top:6px;">ë¬¸ì œ ìœ í˜• ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í™”ë©´ì´ <b>ìƒˆ ë¬¸ì œ</b>ë¡œ êµì²´ë©ë‹ˆë‹¤.</div>
    </div>
  </header>

  <main>
    <div id="card" class="card" aria-live="polite">
      <div class="qtitle">ì‹œì‘í•˜ë ¤ë©´ ìœ„ì—ì„œ í€´ì¦ˆ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”.</div>
      <div class="qmeta">ì„±ë„(ì´ë¯¸ì§€) í€´ì¦ˆì—ì„œëŠ” ê·¸ë¦¼ì„ í´ë¦­í•˜ë©´ í¬ê²Œ/ì‘ê²Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    </div>

    <div class="brand">
      <!-- í”„ë¡œì íŠ¸ ë‚´ ì •ì  íŒŒì¼ ê²½ë¡œì— ë§ì¶° ì €ì¥: public/brand/midnight_logo.png -->
      <img src="/public/brand/midnight_logo.png" alt="MIDNIGHT brand">
    </div>
  </main>

  <footer class="credit">
    ì´ AI ì±—ë´‡ì€ ë¯¸ë“œë‚˜ì‡ì˜ ê¸°íšê³¼ ChatGPTì˜ AI ì œì‘ ì§€ì›ìœ¼ë¡œ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤.<br>
    ë³„ìë¦¬Â·íƒœì–‘ê³„ ë°ì´í„°ëŠ” IAU(êµ­ì œì²œë¬¸ì—°ë§¹), Sky & Telescope, Stellarium, HYG Database ë“±ì˜ ê³µê°œ ìë£Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ í™œìš©í–ˆìŠµë‹ˆë‹¤.<br><br>
    This AI chatbot was planned by MIDNIGHT and built with AI support from ChatGPT.<br>
    Constellation and solar system data are based on public resources from IAU, Sky & Telescope, Stellarium, and the HYG Database.<br><br>
    <a class="yt" href="https://www.youtube.com/@midnight_astro" target="_blank" rel="noopener">
      Youtube ë¯¸ë“œë‚˜ì‡ ì²œì²´ê´€ì¸¡ channel
    </a><br><br>
    <span class="warn">
      Â© <span id="year"></span> MIDNIGHT Â· All Rights Reserved.<br><br>
      âš ï¸ ë³¸ AI ì±—ë´‡ê³¼ ê·¸ ì½˜í…ì¸ ëŠ” ì €ì‘ê¶Œë²•ì˜ ë³´í˜¸ë¥¼ ë°›ìŠµë‹ˆë‹¤.<br>
      ë¬´ë‹¨ ë³µì œ, ìˆ˜ì •, ë°°í¬ ë° ìƒì—…ì  ì´ìš©ì„ ê¸ˆí•©ë‹ˆë‹¤.<br><br>
      âš ï¸ This AI chatbot and its contents are protected under copyright law.<br>
      Unauthorized reproduction, modification, distribution, or commercial use is strictly prohibited.
    </span>
  </footer>

  <script>
    // ì—°ë„ ìë™ ë°˜ì˜
    document.getElementById('year').textContent = new Date().getFullYear();

    // ì„œë²„ ìƒíƒœ ì²´í¬
    (async function health() {
      const $health = document.getElementById('health');
      try {
        const r = await fetch('/health', {cache:'no-store'});
        if (!r.ok) throw new Error();
        await r.json();
        $health.textContent = 'ì„œë²„ ì—°ê²° OK';
        $health.classList.remove('fail'); $health.classList.add('ok');
      } catch {
        $health.textContent = 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨';
        $health.classList.remove('ok'); $health.classList.add('fail');
      }
    })();

    // í€´ì¦ˆ ê°€ì ¸ì˜¤ê¸° (ì—ëŸ¬ë¥¼ ì¹´ë“œì— í‘œì‹œ)
    async function fetchQuiz(mode) {
      const m = mode || 'random';
      try {
        const r = await fetch('/chat', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ mode: m })
        });
        if (!r.ok) {
          const text = await r.text();
          throw new Error(`HTTP ${r.status} /chat â†’ ${text}`);
        }
        const resp = await r.json();
        if (resp?.type !== 'quiz' || !resp?.data) {
          throw new Error('Invalid payload from /chat');
        }
        return resp.data;
      } catch (e) {
        const $card = document.getElementById('card');
        $card.innerHTML = `
          <div class="qtitle">ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆì–´ìš”.</div>
          <div class="qmeta" style="color:#b91c1c;">${e.message}</div>
          <div class="hint" style="margin-top:8px;">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜, Render Logsë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.</div>
        `;
        console.warn(e);
        return null;
      }
    }

    const $card = document.getElementById('card');
    let current = null, currentMode = 'random';

    function labelMode(m){
      switch(m){
        case 'random': return 'ëœë¤';
        case 'image': return 'ì„±ë„(ì´ë¯¸ì§€)';
        case 'season': return 'ê³„ì ˆ';
        case 'star': return 'ë°ì€ ë³„ ì†Œì†';
        case 'hemisphere': return 'ë°˜êµ¬ êµ¬ë¶„';
        case 'lunar': return 'ë‹¬';
        case 'solar': return 'íƒœì–‘ê³„';
        default: return m;
      }
    }

    function renderQuiz(data, mode){
      current = data; currentMode = mode || currentMode;
      const isHemi = data.choices.every(c => c === 'ë¶ë°˜êµ¬' || c === 'ë‚¨ë°˜êµ¬');
      const isImageQuiz = !!data.image;

      const btns = data.choices.map((label, idx) =>
        `<button class="opt-btn" data-idx="${idx}" type="button">${idx+1}. ${label}</button>`
      ).join('');

      const imgBlock = isImageQuiz ? `
        <div class="qimg-wrap">
          <img id="qimg" class="qimg" src="${data.image}" alt="ì„±ë„ ì´ë¯¸ì§€">
        </div>
        <div class="hint" style="text-align:center; margin-top:4px; font-size:11px;">
          Charts Â© IAU / Sky & Telescope Â· CC BY 4.0
        </div>
      ` : '';

      $card.innerHTML = `
        <div class="qtitle">Q) ${data.question}</div>
        <div class="qmeta">${isHemi ? '2ì§€ì„ ë‹¤' : (data.choices.length+'ì§€ì„ ë‹¤')} Â· ëª¨ë“œ: ${labelMode(currentMode)}</div>
        ${imgBlock}
        <div class="opts ${isHemi ? 'cols-2' : 'cols-1'}" id="opts">
          ${btns}
        </div>
        <div class="footer">
          <div class="hint">ì •ë‹µì„ ê³ ë¥´ì„¸ìš”.</div>
          <div><button id="btnNext" class="ghost" type="button" disabled>ë‹¤ìŒ ë¬¸ì œ</button></div>
        </div>
      `;

      const $img = document.getElementById('qimg');
      if ($img) $img.addEventListener('click', ()=> $img.classList.toggle('lg'));

      document.querySelectorAll('.opt-btn').forEach(btn=>{
        btn.addEventListener('click', ()=> onChoose(btn));
      });
      document.getElementById('btnNext').addEventListener('click', async ()=>{
        const next = await fetchQuiz(currentMode);
        if (next) renderQuiz(next);
      });
    }

    function onChoose(btn){
      const idx = Number(btn.dataset.idx);
      const isCorrect = idx === current.answerIndex;
      document.querySelectorAll('.opt-btn').forEach(b=>{
        b.disabled = true;
        const i = Number(b.dataset.idx);
        if (i === current.answerIndex) b.classList.add('correct');
        if (i === idx && !isCorrect) b.classList.add('wrong');
      });
      const res = document.createElement('div');
      res.className = 'result ' + (isCorrect ? 'ok' : 'bad');
      res.textContent = isCorrect
        ? `ì •ë‹µì…ë‹ˆë‹¤! ì¶•í•˜í•©ë‹ˆë‹¤~ğŸ‰  ${current.explanation ? 'Â· ' + current.explanation : ''}`
        : `ì•„ì‰¬ì›Œìš” ğŸ˜¯ ì •ë‹µì€ ã€Œ${current.choices[current.answerIndex]}ã€ ì…ë‹ˆë‹¤. ${current.explanation ? 'Â· ' + current.explanation : ''}`;
      $card.appendChild(res);
      const $btnNext = document.getElementById('btnNext');
      $btnNext.disabled = false;
      $btnNext.classList.remove('ghost'); $btnNext.classList.add('primary');
    }

    // ìƒë‹¨ ëª¨ë“œ ë²„íŠ¼
    document.querySelectorAll('button[data-mode]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        document.querySelectorAll('button[data-mode]').forEach(x=>x.classList.remove('primary'));
        b.classList.add('primary');
        const mode = b.getAttribute('data-mode');
        const q = await fetchQuiz(mode);
        if (q) renderQuiz(q, mode);
      });
    });
  </script>
</body>
</html>
