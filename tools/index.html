<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë¯¸ë“œë‚˜ì‡ì˜ ì²œë¬¸ í€´ì¦ˆ (with. AI)</title>
  <!-- ìºì‹œ ë¬´íš¨í™” -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root { --fg:#0f172a; --muted:#6b7280; --bg:#f6f7fb; --card:#fff; --line:#e5e7eb;
            --primary:#111827; --ok:#16a34a; --bad:#dc2626; --btn:#fff; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, system-ui, Segoe UI, Roboto, 'Noto Sans KR', sans-serif; background: var(--bg); color: var(--fg); }
    header { position: sticky; top: 0; z-index: 10; background: rgba(246,247,251,.85); backdrop-filter: blur(8px); border-bottom: 1px solid var(--line); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 14px 16px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .space { flex: 1; }
    .hint { color: var(--muted); font-size: 12px; }
    button { appearance: none; border:1px solid var(--line); background: var(--btn); padding:10px 14px; border-radius: 12px; cursor:pointer; }
    button.primary { background: var(--primary); color:#fff; border:none; }
    button.ghost { background:transparent; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .seg { display:flex; gap:6px; flex-wrap:wrap; }
    main { padding: 22px 16px 10px; }
    .card { margin: 0 auto; max-width: 880px; background: var(--card); border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.06); border:1px solid var(--line); padding: 18px; }
    .qtitle { font-size: 18px; font-weight: 700; line-height: 1.35; }
    .qmeta { margin-top: 6px; font-size: 12px; color: var(--muted); }
    .qimg-wrap { margin: 10px 0 6px; display:flex; justify-content:center; }
    .qimg { max-width:100%; height:auto; max-height: 42vh; object-fit: contain; border:1px solid var(--line); border-radius:8px; background:#fff; cursor: zoom-in; }
    .qimg.lg { max-height: 86vh; cursor: zoom-out; }
    @media (max-width: 640px) { .qimg { max-height: 52vh; } }
    .opts { display:grid; gap:10px; margin-top: 10px; }
    .opts.cols-1 { grid-template-columns: 1fr; }
    .opt-btn { padding: 12px; text-align:left; border:1px solid var(--line); border-radius:12px; background:#fff; transition: transform .06s ease, border-color .06s ease; }
    .opt-btn:hover { transform: translateY(-1px); }
    .opt-btn.correct { border-color: #86efac; box-shadow: 0 0 0 3px rgba(22,163,74,.15) inset; }
    .opt-btn.wrong   { border-color: #fca5a5; box-shadow: 0 0 0 3px rgba(220,38,38,.12) inset; }
    .result { margin-top: 12px; padding: 10px 12px; border-radius:12px; font-weight:600; }
    .result.ok  { background: #ecfdf5; color:#065f46; }
    .result.bad { background: #fef2f2; color:#7f1d1d; }
    .footer { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:14px; }
    .badge { border:1px solid var(--line); border-radius: 999px; padding: 4px 10px; font-size: 12px; }
    .badge.ok { color:#047857; border-color:#34d399; }
    .badge.fail { color:#b91c1c; border-color:#f87171; }
    .credit { margin: 16px auto 24px; padding: 12px; text-align: center; font-size: 12px; line-height: 1.6; color: #6b7280; max-width: 980px; }
    .credit .warn { display: block; margin-top: 12px; font-size: 11px; color: #b91c1c; }
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <div style="font-weight:800;">ë¯¸ë“œë‚˜ì‡ì˜ ì²œë¬¸ í€´ì¦ˆ (with. AI)</div>
      <div class="space"></div>
      <div id="health" class="badge fail">ì„œë²„ ì—°ê²° í™•ì¸ ì¤‘â€¦</div>
    </div>
    <div class="wrap">
      <div class="seg" id="modeBar">
        <button data-mode="photo" class="primary">ì²œì²´ ì‚¬ì§„</button>
      </div>
      <div class="hint" style="margin-top:6px;">ì‚¬ì§„ì„ ë³´ê³  ì²œì²´ë¥¼ ë§í˜€ë³´ì„¸ìš”.</div>
    </div>
  </header>

  <main>
    <div id="card" class="card" aria-live="polite">
      <div class="qtitle">â€œì²œì²´ ì‚¬ì§„â€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</div>
      <div class="qmeta">ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ë©´ í¬ê²Œ/ì‘ê²Œ ì „í™˜ë©ë‹ˆë‹¤.</div>
    </div>
  </main>

  <footer class="credit">
    Â© <span id="year"></span> MIDNIGHT Â· All Rights Reserved.<br>
    Unauthorized reproduction, modification, distribution, or commercial use is strictly prohibited.
    <span class="warn">â€» ë³¸ í˜ì´ì§€ì˜ ì¼ë¶€ ì´ë¯¸ì§€ëŠ” ì‚¬ìš©ì ì œê³µ ë¡œì»¬ ì—ì…‹ì…ë‹ˆë‹¤.</span>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // ì„œë²„ ìƒíƒœ
    (async function health() {
      const $health = document.getElementById('health');
      try {
        const r = await fetch('/health', {cache:'no-store'});
        if (!r.ok) throw new Error();
        await r.json();
        $health.textContent = 'ì„œë²„ ì—°ê²° OK';
        $health.classList.remove('fail'); $health.classList.add('ok');
      } catch {
        $health.textContent = 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨';
        $health.classList.remove('ok'); $health.classList.add('fail');
      }
    })();

    const $card = document.getElementById('card');
    let current = null, currentMode = 'photo';

    async function fetchQuiz(mode) {
      try {
        const r = await fetch('/chat', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ mode })
        });
        if (!r.ok) {
          const t = await r.text();
          throw new Error(`HTTP ${r.status} /chat â†’ ${t}`);
        }
        const data = await r.json();
        return data.data;
      } catch (e) {
        $card.innerHTML = `<div class="qtitle">ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div><div class="qmeta" style="color:#b91c1c">${e.message}</div>`;
        return null;
      }
    }

    function renderQuiz(data, mode){
      current = data; currentMode = mode;
      const btns = data.choices.map((c,i)=>
        `<button class="opt-btn" data-idx="${i}">${i+1}. ${c}</button>`).join('');
      const imgBlock = data.image ? `
        <div class="qimg-wrap"><img id="qimg" class="qimg" src="${data.image}" alt="ì²œì²´ ì´ë¯¸ì§€"></div>
        <div class="hint" style="text-align:center; margin-top:4px; font-size:11px;">
          ${data.credit ? data.credit : ""}
        </div>
      ` : "";

      $card.innerHTML = `
        <div class="qtitle">${data.question}</div>
        <div class="qmeta">${data.choices.length}ì§€ì„ ë‹¤ Â· ëª¨ë“œ: ì²œì²´ ì‚¬ì§„</div>
        ${imgBlock}
        <div class="opts cols-1">${btns}</div>
        <div class="footer">
          <div class="hint">ì •ë‹µì„ ê³ ë¥´ì„¸ìš”.</div>
          <div><button id="btnNext" class="ghost" type="button" disabled>ë‹¤ìŒ ë¬¸ì œ</button></div>
        </div>
      `;

      const $img = document.getElementById('qimg');
      if ($img) $img.addEventListener('click', ()=> $img.classList.toggle('lg'));

      document.querySelectorAll('.opt-btn').forEach(b=>{
        b.onclick=()=>onChoose(b);
      });
      document.getElementById('btnNext').onclick=async()=>{
        const q=await fetchQuiz(currentMode);
        if(q) renderQuiz(q, currentMode);
      };
    }

    function onChoose(btn){
      const idx = Number(btn.dataset.idx);
      const isCorrect = idx===current.answerIndex;
      document.querySelectorAll('.opt-btn').forEach((b,i)=>{
        b.disabled = true;
        if(i===current.answerIndex) b.classList.add('correct');
        if(i===idx && i!==current.answerIndex) b.classList.add('wrong');
      });
      const res=document.createElement('div');
      res.className='result '+(isCorrect?'ok':'bad');
      res.textContent=isCorrect ? `ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰  ${current.explanation||""}`
        : `ì•„ì‰¬ì›Œìš” ğŸ˜¯ ì •ë‹µì€ ã€Œ${current.choices[current.answerIndex]}ã€ ì…ë‹ˆë‹¤. ${current.explanation||""}`;
      $card.appendChild(res);
      const $btnNext = document.getElementById('btnNext');
      $btnNext.disabled=false;
      $btnNext.classList.remove('ghost'); $btnNext.classList.add('primary');
    }

    // ë²„íŠ¼ ë°”ì¸ë”©(í˜„ì¬ëŠ” photoë§Œ)
    document.querySelectorAll('#modeBar button[data-mode]').forEach(b=>{
      b.onclick=async()=>{
        document.querySelectorAll('#modeBar button[data-mode]').forEach(x=>x.classList.remove('primary'));
        b.classList.add('primary');
        const mode=b.dataset.mode; // "photo"
        const q=await fetchQuiz(mode);
        if(q) renderQuiz(q, mode);
      };
    });
  </script>
</body>
</html>
